# CVE-2010-3333


## windbg

```
This exception may be expected and handled.
eax=0000c8ac ebx=05000000 ecx=00001ab5 edx=00000000 esi=11045de4 edi=00130000
eip=30ed442c esp=0012a200 ebp=0012a238 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files\Common Files\Microsoft Shared\office11\mso.dll - 
mso!Ordinal1246+0x16b0:

!address edi    查看edi的值
db esp
lmm mso v       查看mso模块详细信息
```
eip指向30ed442c

IDA打开mso.dll之后
```
.text:30ED4406 sub_30ED4406    proc near               ; DATA XREF: .text:30DA33F4o
.text:30ED4406
.text:30ED4406 arg_0           = dword ptr  4
.text:30ED4406 arg_4           = dword ptr  8
.text:30ED4406 arg_8           = dword ptr  0Ch
.text:30ED4406
.text:30ED4406                 push    edi
.text:30ED4407                 mov     edi, [esp+4+arg_4]
.text:30ED440B                 test    edi, edi
.text:30ED440D                 jz      short loc_30ED4436
.text:30ED440F                 mov     eax, [esp+4+arg_0]
.text:30ED4413                 mov     ecx, [eax+8]
.text:30ED4416                 and     ecx, 0FFFFh
.text:30ED441C                 push    esi
.text:30ED441D                 mov     esi, ecx
.text:30ED441F                 imul    esi, [esp+8+arg_8]
.text:30ED4424                 add     esi, [eax+10h]
.text:30ED4427                 mov     eax, ecx
.text:30ED4429                 shr     ecx, 2
.text:30ED442C                 rep movsd            //循环存取 导致溢出
.text:30ED442E                 mov     ecx, eax
.text:30ED4430                 and     ecx, 3
.text:30ED4433                 rep movsb
.text:30ED4435                 pop     esi
```
bp 30ed442c<br>
之后运行，查看栈回溯<br>
```
0:000> kb           打印前三个函数参数的当前调用堆栈
ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.      
0012a238 30f0b56b 0012a3a4 00000000 ffffffff mso!Ordinal1246+0x16b0                 当前的call
0012a268 30f0b4f9 0012a3f0 0012a3a4 00000000 mso!Ordinal1273+0x2581                 前一个call
0012a4b4 30d4d795 00000000 0012a4f4 00000000 mso!Ordinal1273+0x250f
0012a4dc 30d4d70d 30d4d5a8 01551a48 01551a80 mso!Ordinal5575+0xf9
0012a4e0 30d4d5a8 01551a48 01551a80 01551930 mso!Ordinal5575+0x71
0012a4e4 01551a48 01551a80 01551930 30dce40c mso!Ordinal4099+0xf5
0012a4e8 01551a80 01551930 30dce40c 00000000 0x1551a48
0012a4ec 01551930 30dce40c 00000000 01551694 0x1551a80
0012a4f0 30dce40c 00000000 01551694 0012b2a0 0x1551930
0012a4f4 00000000 01551694 0012b2a0 00000000 mso!Ordinal2940+0x1588c
```
ub mso!Ordinal1273+0x2581       查看对应地址指令<br>
```
mso!Ordinal1273+0x256d:
30f0b557 23c1            and     eax,ecx
30f0b559 50              push    eax
30f0b55a 8d47ff          lea     eax,[edi-1]
30f0b55d 50              push    eax
30f0b55e 8b4508          mov     eax,dword ptr [ebp+8]
30f0b561 6a00            push    0
30f0b563 ff750c          push    dword ptr [ebp+0Ch]
30f0b566 e857000000      call    mso!Ordinal1273+0x25d8 (30f0b5c2)
```

bp 30f0b5c2<br>
然后单步一直跟<br>
```
0:000> p
eax=0000c8ac ebx=05000000 ecx=0000322b edx=00000000 esi=1104000c edi=0012a228
eip=30ed442c esp=0012a200 ebp=0012a238 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
mso!Ordinal1246+0x16b0:
30ed442c f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
0:000> db esi
1104000c  41 61 30 41 61 31 41 61-32 41 61 33 41 61 34 41  Aa0Aa1Aa2Aa3Aa4A
1104001c  61 35 41 61 36 41 61 37-41 61 38 41 61 39 41 62  a5Aa6Aa7Aa8Aa9Ab
1104002c  30 41 62 31 41 62 32 41-62 33 41 62 34 41 62 35  0Ab1Ab2Ab3Ab4Ab5
1104003c  41 62 36 41 62 37 41 62-38 41 62 39 41 63 30 41  Ab6Ab7Ab8Ab9Ac0A
1104004c  63 31 41 63 32 41 63 33-41 63 34 41 63 35 41 63  c1Ac2Ac3Ac4Ac5Ac
1104005c  36 41 63 37 41 63 38 41-63 39 41 64 30 41 64 31  6Ac7Ac8Ac9Ad0Ad1
1104006c  41 64 32 41 64 33 41 64-34 41 64 35 41 64 36 41  Ad2Ad3Ad4Ad5Ad6A
1104007c  64 37 41 64 38 41 64 39-41 65 30 41 65 31 41 65  d7Ad8Ad9Ae0Ae1Ae
0:000> ? ebp-edi               ;用来计算寄存器差值
Evaluate expression: 16 = 00000010
这个ebp由ida查看可知 保存的是栈的地址
;ebp一直保存上一个esp
.text:30F0B5C2                 push    ebp
.text:30F0B5C3                 mov     ebp, esp
.text:30F0B5C5                 sub     esp, 14h
.text:30F0B5C8                 cmp     [ebp+arg_10], 0
```


